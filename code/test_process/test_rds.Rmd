---
title: "test_rds"
output: html_document
---

```{r setup, include=FALSE}
library(Seurat)
library(here)
library(tidyverse)
library(cowplot)
library(ggplot2)
library(patchwork)
library(sctransform)
```

setwd("~/R/scRNA_IPF_data/data/GSE135893_IPF_1")
ild_data <- Read10X(data.dir = 'GSE135893_seurat/', gene.column=1)
```{r "setup", include=FALSE}
knitr::opts_knit$set(root.dir = "~/R/scRNA_IPF_data/data/GSE135893_IPF_1") 
# 경로를 다시 설정 setwd 를 사용하면 오류가 발생해서 위의 코드로 문제 해결 
```

```{r}

df <- readRDS('GSE135893_ILD_annotated_fullsize.rds')

```


```{r}
df@meta.data
```

```{r}
levels(df)
```
```{r}
unique(df@meta.data$Diagnosis)
# 원래는 밑에 levels 값도 나와야 되는데 왜 이거는 나오지 않는거지..? 
```
```{r}
# 우선은 levels 생각하지 않고 지워본 이후에 levels(df)를 통해서 확인해보기
df <- df %>% 
  subset(Diagnosis != "NSIP" & Diagnosis != "cHP" & Diagnosis != "Unclassifiable ILD" & Diagnosis != "sacroidosis")

unique(df$Diagnosis)
```
```{r}
dim(df)
#dim(newdf) # dim 이 축소된것을 통해서 데이터 걸러졌다는것은 확인 가능 
nrow(df)
ncol(df)


```

```{r}
unique(df$celltype)
```
```{r}
# Dimplot 
DimPlot(object = df, reduction = "umap", group.by = "celltype", label = TRUE, label.size = 3, repel = TRUE) + NoLegend() + coord_fixed(ratio = 0.5)

# wnn.umap 으로 실행했을 경우 Error: Cannot find 'wnn.umap' in this Seurat object 라는 오류가 발생해서 umap으로 우선은 실시 
```


# Mapping 
```{r}
head(covid)
```

```{r}
# sctransform -> 시간 너무 오래 걸려서 단축시키기 위한 method -> 설치후 sctransform( , method = "glmGamPoi") 이렇게 추가해주기 
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

BiocManager::install("glmGamPoi")
```




```{r}
# covid data도 동일하게 SCTransform 
covid <- SCTransform(covid, method = 'glmGamPoi', verbose = TRUE)

```

```{r}
covid@meta.data
```



```{r}
# FindTransferAnchors -> tutorial method 
#anchors <- FindTransferAnchors(
#  reference = df,
#  query = covid,
#  normalization.method = "SCT",
#  recompute.residuals = TRUE,
#  dims = 1:20,
#  verbose = TRUE
#)

anchors <- FindTransferAnchors(
  reference = df,
  query = covid,
  normalization.method = "SCT",
  recompute.residuals = TRUE,
  dims = 1:20,
  verbose = TRUE
)

suppressWarnings(FindTransferAnchors())


```
```{r}
suppressWarnings(print(anchors))

```























