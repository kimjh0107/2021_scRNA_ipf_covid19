---
title: "11_New_Epithelial_annotation"
output: html_document
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(cowplot)
library(knitr)

library(BiocManager)
library(sctransform)
library(glmGamPoi)
library(Matrix)
library(future)
library(future.apply)
```


# Epithelial
```{r}
refquery <- readRDS(here('explore/RDS/07_Every_celltype.RDS'))
head(refquery)
```


```{r}
cells <- refquery@meta.data
```

```{r}
table(is.na(refquery@meta.data$orig.ident))
table(is.na(refquery@meta.data$cellbarcodes))
unique(cells$Diagnosis)

```

```{r}
cells %>% select(Diagnosis, cell_type_submain)

cell_count_df <- cells %>%
  select(orig.ident, Diagnosis, cell_type_submain) %>%
  group_by(orig.ident, Diagnosis, cell_type_submain) %>%
  summarise(count_cell = n(), .groups = "drop")

sum_cell_df <- cell_count_df %>%
  group_by(orig.ident) %>%
  summarise(sum_cell = sum(count_cell))

cell_count_df %>% left_join(sum_cell_df, by = 'orig.ident') %>%
  mutate(percentage = count_cell / sum_cell * 100) %>%
  filter(cell_type_submain == 'AT2') %>%
  ggplot(aes(Diagnosis, percentage)) + geom_jitter()

cell_count_df %>% filter(Diagnosis == 'COVID')
```


cells %>%
  select(Disease, cell_type_submain.x)

cell_count_df <- cells %>%
  select(batch, Disease, cell_type_submain) %>%
  group_by(batch, Disease, cell_type_submain) %>%
  summarise(count_cell = n(), .groups = "drop") 
  
sum_cell_df <- cell_count_df %>%
  group_by(batch) %>%
  summarise(sum_cell = sum(count_cell))

cell_count_df %>% left_join(sum_cell_df, by = 'batch') %>%
  mutate(percentage = count_cell / sum_cell * 100) %>%
  filter(cell_type_submain == 'AT2') %>%
  ggplot(aes(Disease, percentage)) + geom_jitter()

cell_count_df %>% filter(Disease == 'COV')
